services:
  # PostgreSQL Primary (Master) - для записи
  postgres-primary:
    image: postgres:16
    restart: unless-stopped
    environment:
      - POSTGRES_USER=game
      - POSTGRES_PASSWORD=gamepass
      - POSTGRES_DB=econ
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicatorpass
    ports:
      - "5432:5432"
    volumes:
      - pgdata_primary:/var/lib/postgresql/data
      - ./sql/init.sql:/docker-entrypoint-initdb.d/10-init.sql:ro
      - ./sql/primary-setup.sql:/docker-entrypoint-initdb.d/20-primary-setup.sql:ro
      - ./sql/setup-pg-hba.sh:/docker-entrypoint-initdb.d/30-setup-pg-hba.sh:ro
    command: >
      postgres 
      -c wal_level=replica 
      -c max_wal_senders=10 
      -c max_replication_slots=10 
      -c synchronous_commit=off
      -c listen_addresses='*'
      -c hot_standby=on
    networks:
      - postgres-cluster

  # PostgreSQL Replica 1 - для чтения
  postgres-replica1:
    image: postgres:16
    restart: unless-stopped
    environment:
      - POSTGRES_USER=game
      - POSTGRES_PASSWORD=gamepass
      - POSTGRES_DB=econ
      - PGUSER=postgres
      - POSTGRES_PRIMARY_HOST=postgres-primary
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicatorpass
      - POSTGRES_SERVICE_NAME=postgres-replica1
    ports:
      - "5433:5432"
    volumes:
      - pgdata_replica1:/var/lib/postgresql/data
      - ./sql/replica-setup.sh:/docker-entrypoint-initdb.d/setup-replica.sh:ro
    depends_on:
      - postgres-primary
    networks:
      - postgres-cluster

  # PostgreSQL Replica 2 - для чтения
  postgres-replica2:
    image: postgres:16
    restart: unless-stopped
    environment:
      - POSTGRES_USER=game
      - POSTGRES_PASSWORD=gamepass
      - POSTGRES_DB=econ
      - PGUSER=postgres
      - POSTGRES_PRIMARY_HOST=postgres-primary
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicatorpass
      - POSTGRES_SERVICE_NAME=postgres-replica2
    ports:
      - "5434:5432"
    volumes:
      - pgdata_replica2:/var/lib/postgresql/data
      - ./sql/replica-setup.sh:/docker-entrypoint-initdb.d/setup-replica.sh:ro
    depends_on:
      - postgres-primary
    networks:
      - postgres-cluster

  redis:
    image: redis:7
    restart: unless-stopped
    command: ["redis-server","--appendonly","yes","--save","900","1","300","10","60","10000"]
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - redisdata:/data

  nats:
    image: nats:2
    restart: unless-stopped
    command: ["-js","-m","${NATS_MONITOR_PORT}","-DV"]
    ports:
      - "${NATS_PORT}:4222"
      - "${NATS_MONITOR_PORT}:8222"

  # PgBouncer for PostgreSQL Master - для записи
  pgbouncer-master:
    image: edoburu/pgbouncer:latest
    restart: unless-stopped
    environment:
      - DB_USER=game
      - DB_PASSWORD=gamepass
      - DB_HOST=postgres-primary
      - DB_PORT=5432
      - DB_NAME=econ
    ports:
      - "6432:5432"
    volumes:
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro
    depends_on:
      - postgres-primary
    networks:
      - postgres-cluster

  # PgBouncer for PostgreSQL Replica 1 - для чтения
  pgbouncer-replica1:
    image: edoburu/pgbouncer:latest
    restart: unless-stopped
    environment:
      - DB_USER=game
      - DB_PASSWORD=gamepass
      - DB_HOST=postgres-replica1
      - DB_PORT=5432
      - DB_NAME=econ
    ports:
      - "6433:5432"
    volumes:
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro
    depends_on:
      - postgres-replica1
    networks:
      - postgres-cluster

  # PgBouncer for PostgreSQL Replica 2 - для чтения
  pgbouncer-replica2:
    image: edoburu/pgbouncer:latest
    restart: unless-stopped
    environment:
      - DB_USER=game
      - DB_PASSWORD=gamepass
      - DB_HOST=postgres-replica2
      - DB_PORT=5432
      - DB_NAME=econ
    ports:
      - "6434:5432"
    volumes:
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro
    depends_on:
      - postgres-replica2
    networks:
      - postgres-cluster

volumes:
  pgdata_primary:
  pgdata_replica1:
  pgdata_replica2:
  redisdata:
  qdrant_storage:

networks:
  postgres-cluster:
    driver: bridge

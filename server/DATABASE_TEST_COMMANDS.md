# Тестовые команды для проверки master-slave репликации БД

## Описание

В Minecraft клиент добавлены тестовые команды для проверки работы master-slave репликации PostgreSQL.

## Доступные команды

### `/dbtest ping`
Простая проверка доступности API сервера.

**Что показывает:**
- Доступность API на http://localhost:8081
- Статус health endpoint
- Инструкции по запуску если сервер недоступен

**Пример вывода:**
```
[DB Test] API сервер доступен! ✓
[DB Test] URL: http://localhost:8081
[DB Test] Статус: UP
```

### `/dbtest all`
Запускает все тесты подряд с паузами между ними.

**Что включает:**
1. Проверка API подключения
2. Статус баз данных
3. Статус репликации
4. Тест replica соединений
5. Тест операций чтения
6. Тест операций записи
7. Тест балансировки нагрузки

**Использование:**
```
/dbtest all
```

### `/dbtest status`
Проверяет общий статус всех баз данных.

**Что показывает:**
- Статус соединений с Primary и Replica серверами
- Время последней проверки
- Количество подключенных реплик

**Пример вывода:**
```
[DB Test] Статус соединений: Primary: OK, Replica1: OK, Replica2: OK
[DB Test] Время проверки: Wed Sep 10 12:34:56 CEST 2025
[DB Test] Подключенных реплик: 2
```

### `/dbtest replication`
Показывает детальную информацию о репликации.

**Что показывает:**
- Статус слотов репликации (replica1_slot, replica2_slot)
- Информацию о подключенных репликах
- Lag репликации в байтах

**Пример вывода:**
```
[DB Test] Слоты репликации:
[DB Test]   - replica1_slot: Активен
[DB Test]   - replica2_slot: Активен
[DB Test] Подключенные реплики:
[DB Test]   - replica_1: streaming (lag: 0 bytes)
[DB Test]   - replica_2: streaming (lag: 0 bytes)
```

### `/dbtest write <данные>`
Тестирует операцию записи в primary базу данных.

**Параметры:**
- `<данные>` - произвольная строка для тестирования

**Что делает:**
- Создает тестовую запись в primary БД
- Проверяет успешность операции записи

**Пример использования:**
```
/dbtest write test123
```

### `/dbtest read`
Тестирует операцию чтения из replica баз данных.

**Что делает:**
- Читает данные вашего игрока из replica БД
- Показывает ваш UUID и уровень скилла Mining

**Пример вывода:**
```
[DB Test] Чтение выполнено успешно!
[DB Test] Ваш UUID: 12345678-1234-1234-1234-123456789012
[DB Test] Уровень Mining: 3
```

### `/dbtest replicas`
Тестирует соединения с обеими репликами.

**Что показывает:**
- Доступность каждой реплики
- Информацию о базе данных
- Подтверждение что сервер работает в режиме replica
- Результат случайного чтения

**Пример вывода:**
```
[DB Test] Replica 1: ОК
[DB Test]   - БД: econ (replica: Да)
[DB Test] Replica 2: ОК
[DB Test]   - БД: econ (replica: Да)
[DB Test] Случайное чтение: ОК
[DB Test]   - Игроков в БД: 15
[DB Test]   - Читали из replica: Да
```

### `/dbtest load`
Тестирует балансировку нагрузки между репликами.

**Что делает:**
- Выполняет 10 запросов чтения подряд
- Измеряет время выполнения
- Проверяет успешность операций

**Пример вывода:**
```
[DB Test] Результаты балансировки:
[DB Test]   - Успешных запросов: 10/10
[DB Test]   - Среднее время: 45.2ms
[DB Test] Балансировка работает отлично! ✓
```

## Цветовая схема сообщений

- **§6 (Золотой)** - Начало тестирования
- **§a (Зеленый)** - Успешные результаты
- **§e (Желтый)** - Информационные данные
- **§c (Красный)** - Ошибки и проблемы

## Требования

1. **Запущенный кластер PostgreSQL** - используйте `start-postgres-cluster.bat`
2. **Работающий Quarkus API** - должен быть доступен на `http://localhost:8081`
3. **Авторизованный игрок** - некоторые команды требуют UUID игрока

## Диагностика проблем

### Если команды не работают:
1. **Сначала выполните:** `/dbtest ping`
2. Если API недоступен - запустите Quarkus: `cd economy-quarkus && ./gradlew quarkusDev`
3. Убедитесь что PostgreSQL кластер запущен: `.\start-postgres-cluster.bat`
4. Убедитесь что вы авторизованы в игре

### Если replica недоступны:
1. Проверьте логи: `docker-compose logs postgres-replica1`
2. Убедитесь что primary сервер запущен
3. Проверьте статус репликации: `/dbtest replication`

### Если высокий lag:
1. Проверьте нагрузку на primary сервер
2. Убедитесь что сеть между контейнерами работает
3. Посмотрите метрики производительности

## Автоматическое тестирование

### Быстрый тест
Выполните одну команду для проверки всей системы:
```
/dbtest all
```

### Ручной тест
Для пошаговой диагностики выполните команды в следующем порядке:

1. `/dbtest ping` - проверить доступность API
2. `/dbtest status` - проверить общий статус
3. `/dbtest replication` - проверить репликацию
4. `/dbtest replicas` - проверить replica серверы
5. `/dbtest read` - проверить чтение
6. `/dbtest write test` - проверить запись
7. `/dbtest load` - проверить балансировку

### Проверка при проблемах
Если что-то не работает:
1. `/dbtest ping` - первая команда для диагностики
2. Исправьте проблемы с API если нужно
3. `/dbtest all` - полный тест после исправлений

Если все команды выполняются успешно, ваша master-slave репликация работает корректно!
